rules_version = '2';

// Firebase Storage Security Rules for TuCitaSegura
// Copy and paste these rules into Firebase Console > Storage > Rules

service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to get user gender
    function getUserGender(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.gender;
    }

    // Helper function to get user role
    function getUserRole(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.userRole;
    }

    // Helper function to check if user is concierge viewing their applicants
    function canConciergeViewApplicant(conciergeId, applicantId) {
      // Get all active events from this concierge
      let events = get(/databases/$(database)/documents/vip_events).data;
      // Check if applicant has applied to any active event from this concierge
      // This is a simplified check - in production you'd query vip_applications collection
      return getUserRole(conciergeId) == 'concierge';
    }

    // Profile photos - avatars and gallery photos
    match /profile_photos/{userId}/{filename} {
      // LECTURA: Solo usuarios autenticados del género opuesto pueden ver fotos
      // Hombres ven fotos de mujeres, mujeres ven fotos de hombres
      // Concierges pueden ver fotos de mujeres que aplicaron a sus eventos
      allow read: if request.auth != null && (
        // Usuario viendo su propia foto
        request.auth.uid == userId ||
        // Usuario del género opuesto
        (getUserGender(request.auth.uid) == 'masculino' && getUserGender(userId) == 'femenino') ||
        (getUserGender(request.auth.uid) == 'femenino' && getUserGender(userId) == 'masculino') ||
        // Concierge viendo perfil de mujer
        (getUserRole(request.auth.uid) == 'concierge' && getUserGender(userId) == 'femenino') ||
        // Admins pueden ver todas
        getUserRole(request.auth.uid) == 'admin'
      );

      // ESCRITURA: Solo el dueño puede subir/modificar sus fotos
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024  // Max 5MB
                   && request.resource.contentType.matches('image/.*');  // Images only
    }

    // Event photos for VIP events (uploaded by concierges)
    match /event_photos/{eventId}/{filename} {
      // LECTURA: Solo mujeres autenticadas pueden ver fotos de eventos VIP
      allow read: if request.auth != null && (
        getUserGender(request.auth.uid) == 'femenino' ||
        getUserRole(request.auth.uid) == 'concierge' ||
        getUserRole(request.auth.uid) == 'admin'
      );

      // ESCRITURA: Solo concierges pueden subir fotos de eventos
      allow write: if request.auth != null
                   && getUserRole(request.auth.uid) == 'concierge'
                   && request.resource.size < 10 * 1024 * 1024  // Max 10MB
                   && request.resource.contentType.matches('image/.*');
    }

    // SOS emergency photos/videos
    match /sos_evidence/{userId}/{filename} {
      // LECTURA: Solo admins y el usuario que subió la evidencia
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        getUserRole(request.auth.uid) == 'admin'
      );

      // ESCRITURA: Solo el dueño puede subir evidencia SOS
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 50 * 1024 * 1024;  // Max 50MB
    }

    // Verification documents (ID, proof of address, etc.)
    match /verification_docs/{userId}/{filename} {
      // LECTURA: Solo admins pueden leer documentos de verificación
      allow read: if request.auth != null
                  && getUserRole(request.auth.uid) == 'admin';

      // ESCRITURA: Usuarios pueden subir sus propios documentos de verificación
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024;  // Max 10MB
    }

    // Chat attachments (images, videos, files)
    match /chat_attachments/{conversationId}/{filename} {
      // LECTURA: Solo participantes de la conversación
      allow read: if request.auth != null
                  && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;

      // ESCRITURA: Solo participantes pueden subir adjuntos
      allow write: if request.auth != null
                   && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants
                   && request.resource.size < 25 * 1024 * 1024;  // Max 25MB
    }

    // Default: deny all other paths
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
