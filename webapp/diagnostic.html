<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Firebase - TuCitaSegura</title>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0369a1 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        .test-button {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        .test-button:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        .status-info { background: #3b82f6; }
        .log-entry {
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .log-success { border-left-color: #10b981; }
        .log-error { border-left-color: #ef4444; }
        .log-warning { border-left-color: #f59e0b; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .recommendation {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
            border-left: 4px solid #f59e0b;
        }
        .recommendation.critical {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        .recommendation.high {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        .recommendation.medium {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-stethoscope"></i> Diagn√≥stico Firebase</h1>
            <p>Herramienta de diagn√≥stico para TuCitaSegura</p>
        </div>

        <div class="glass">
            <h3><i class="fas fa-chart-line"></i> Estado del Sistema</h3>
            <div id="system-status">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number text-blue-400" id="total-tests">0</div>
                        <div>Total Pruebas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number text-green-400" id="passed-tests">0</div>
                        <div>Exitosas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number text-yellow-400" id="warning-tests">0</div>
                        <div>Advertencias</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number text-red-400" id="failed-tests">0</div>
                        <div>Errores</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass">
            <h3><i class="fas fa-tools"></i> Controles de Diagn√≥stico</h3>
            <div class="text-center">
                <button class="test-button" onclick="runFullDiagnostic()">
                    <i class="fas fa-play"></i> Ejecutar Diagn√≥stico Completo
                </button>
                <button class="test-button" onclick="testFirebaseConnection()">
                    <i class="fas fa-fire"></i> Probar Firebase
                </button>
                <button class="test-button" onclick="testNetworkConnectivity()">
                    <i class="fas fa-wifi"></i> Probar Red
                </button>
                <button class="test-button" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> Limpiar Logs
                </button>
                <button class="test-button" onclick="createTestUsers()">
                    <i class="fas fa-user-plus"></i> Crear cuentas de prueba
                </button>
            </div>
        </div>

        <div class="glass">
            <h3><i class="fas fa-info-circle"></i> Informaci√≥n de Pruebas de Red</h3>
            <div class="recommendation medium">
                <strong>‚ÑπÔ∏è Nota sobre pruebas de conectividad:</strong><br>
                Los errores de red con dominios de Firebase (firebase.googleapis.com, identitytoolkit.googleapis.com, etc.) son <strong>normales</strong> cuando:
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li>El navegador bloquea peticiones CORS por seguridad</li>
                    <li>No hay conexi√≥n a internet activa</li>
                    <li>Los servicios requieren autenticaci√≥n previa</li>
                </ul>
                Estos errores <strong>no afectan</strong> el funcionamiento real de la aplicaci√≥n cuando Firebase est√° correctamente configurado.
            </div>
        </div>

        <div class="glass">
            <h3><i class="fas fa-list"></i> Registro de Pruebas</h3>
            <div id="test-logs" style="max-height: 400px; overflow-y: auto;">
                <div class="text-slate-400 text-center py-8">
                    <i class="fas fa-info-circle text-2xl mb-2"></i>
                    <p>Presiona "Ejecutar Diagn√≥stico Completo" para comenzar</p>
                </div>
            </div>
        </div>

        <div class="glass" id="recommendations-section" style="display: none;">
            <h3><i class="fas fa-lightbulb"></i> Recomendaciones</h3>
            <div id="recommendations-list">
            </div>
        </div>
    </div>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script type="module">
        import { runFirebaseDiagnostic } from './js/diagnostic.js';
        
        window.diagnosticModule = { runFirebaseDiagnostic };
        
        function log(message, type = 'info') {
            const logsContainer = document.getElementById('test-logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            entry.innerHTML = `
                <span class="status-indicator status-${type}"></span>
                <strong>[${new Date().toLocaleTimeString()}]</strong> ${icon} ${message}
            `;
            
            logsContainer.appendChild(entry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function updateStats(results) {
            const total = results.tests.length;
            const passed = results.tests.filter(t => t.status === 'success').length;
            const warnings = results.tests.filter(t => t.status === 'warning').length;
            const failed = results.tests.filter(t => t.status === 'error').length;
            
            document.getElementById('total-tests').textContent = total;
            document.getElementById('passed-tests').textContent = passed;
            document.getElementById('warning-tests').textContent = warnings;
            document.getElementById('failed-tests').textContent = failed;
        }

        function showRecommendations(results) {
            const recommendationsSection = document.getElementById('recommendations-section');
            const recommendationsList = document.getElementById('recommendations-list');
            
            if (results.recommendations.length > 0) {
                recommendationsSection.style.display = 'block';
                recommendationsList.innerHTML = '';
                
                results.recommendations.forEach(rec => {
                    const recElement = document.createElement('div');
                    recElement.className = `recommendation ${rec.priority}`;
                    recElement.innerHTML = `
                        <strong>${rec.priority.toUpperCase()}</strong>: ${rec.message}
                    `;
                    recommendationsList.appendChild(recElement);
                });
            } else {
                recommendationsSection.style.display = 'none';
            }
        }

        window.runFullDiagnostic = async function() {
            try {
                log('üöÄ Iniciando diagn√≥stico completo del sistema...', 'info');
                
                const results = await window.diagnosticModule.runFirebaseDiagnostic();
                
                updateStats(results);
                showRecommendations(results);
                
                log('‚úÖ Diagn√≥stico completado exitosamente', 'success');
                
            } catch (error) {
                log(`‚ùå Error durante el diagn√≥stico: ${error.message}`, 'error');
                console.error('Diagnostic error:', error);
            }
        };

        window.testFirebaseConnection = async function() {
            try {
                log('üî• Probando conexi√≥n con Firebase...', 'info');
                
                // Test basic Firebase connection
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
                const { getAuth } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                
                const firebaseConfig = {
                    apiKey: "AIzaSyAgFcoHwoBpo80rlEHL2hHVZ2DqtjWXh2s",
                    authDomain: "tuscitasseguras-2d1a6.firebaseapp.com",
                    projectId: "tuscitasseguras-2d1a6",
                    storageBucket: "tuscitasseguras-2d1a6.firebasestorage.app",
                    messagingSenderId: "924208562587",
                    appId: "1:924208562587:web:5291359426fe390b36213e"
                };
                
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                
                log('‚úÖ Firebase inicializado correctamente', 'success');
                log('‚úÖ Firebase Auth conectado', 'success');
                
                // Test auth state
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        log(`‚úÖ Usuario autenticado: ${user.email}`, 'success');
                    } else {
                        log('‚ÑπÔ∏è No hay usuario autenticado', 'info');
                    }
                });
                
            } catch (error) {
                log(`‚ùå Error de conexi√≥n Firebase: ${error.message}`, 'error');
                
                if (error.code === 'auth/network-request-failed') {
                    log('üìù Error de red detectado. Posibles causas:', 'warning');
                    log('   ‚Ä¢ Problemas de conexi√≥n a internet', 'warning');
                    log('   ‚Ä¢ CORS bloqueando requests', 'warning');
                    log('   ‚Ä¢ App Check bloqueando requests no verificados', 'warning');
                    log('   ‚Ä¢ Dominio no permitido en Firebase', 'warning');
                }
            }
        };

        window.testNetworkConnectivity = function() {
            log('üåê Probando conectividad de red...', 'info');
            
            // Test basic connectivity
            const isOnline = navigator.onLine;
            log(isOnline ? '‚úÖ Navegador est√° online' : '‚ùå Navegador est√° offline', isOnline ? 'success' : 'error');
            
            // Test Firebase domains with better error handling
            const firebaseDomains = [
                'https://firebase.googleapis.com',
                'https://identitytoolkit.googleapis.com',
                'https://securetoken.googleapis.com'
            ];
            
            firebaseDomains.forEach(domain => {
                // Use a more robust approach with timeout and better error handling
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                fetch(domain, { 
                    method: 'HEAD', 
                    mode: 'no-cors',
                    signal: controller.signal,
                    cache: 'no-cache'
                })
                    .then(() => {
                        clearTimeout(timeoutId);
                        log(`‚úÖ Dominio accesible: ${domain}`, 'success');
                    })
                    .catch((error) => {
                        clearTimeout(timeoutId);
                        if (error.name === 'AbortError') {
                            log(`‚è∞ Timeout accediendo a: ${domain}`, 'warning');
                        } else {
                            log(`‚ö†Ô∏è Posible problema accediendo: ${domain} (${error.message})`, 'warning');
                        }
                    });
            });
            
            // Also test some alternative approaches
            log('üîç Probando conectividad alternativa...', 'info');
            
            // Test using image loading
            const testDomains = [
                'https://www.google.com/favicon.ico',
                'https://firebase.google.com/favicon.ico'
            ];
            
            testDomains.forEach(url => {
                const img = new Image();
                img.onload = () => log(`‚úÖ Imagen cargada: ${url}`, 'success');
                img.onerror = () => log(`‚ö†Ô∏è Error cargando imagen: ${url}`, 'warning');
                img.src = url + '?t=' + Date.now(); // Add cache buster
            });
        };

        window.clearLogs = function() {
            document.getElementById('test-logs').innerHTML = `
                <div class="text-slate-400 text-center py-8">
                    <i class="fas fa-info-circle text-2xl mb-2"></i>
                    <p>Registros limpiados. Presiona un bot√≥n para comenzar.</p>
                </div>
            `;
            document.getElementById('recommendations-section').style.display = 'none';
        };

        window.createTestUsers = async function() {
            try {
                log('üë• Creando cuentas de prueba...', 'info');

                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
                const { getAuth, createUserWithEmailAndPassword, sendEmailVerification, signInWithEmailAndPassword, signOut } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                const { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');

                const firebaseConfig = {
                    apiKey: 'AIzaSyAgFcoHwoBpo80rlEHL2hHVZ2DqtjWXh2s',
                    authDomain: 'tuscitasseguras-2d1a6.firebaseapp.com',
                    projectId: 'tuscitasseguras-2d1a6',
                    storageBucket: 'tuscitasseguras-2d1a6.firebasestorage.app',
                    messagingSenderId: '924208562587',
                    appId: '1:924208562587:web:5291359426fe390b36213e'
                };

                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                async function ensureUser({ email, password, alias, gender, birthDate }) {
                    try {
                        const cred = await createUserWithEmailAndPassword(auth, email, password);
                        log(`‚úÖ Cuenta creada: ${email}`, 'success');
                        try {
                            await sendEmailVerification(cred.user);
                            log(`‚úâÔ∏è Verificaci√≥n enviada: ${email}`, 'info');
                        } catch {}
                    } catch (e) {
                        if (e.code === 'auth/email-already-in-use') {
                            log(`‚ÑπÔ∏è Ya existe: ${email}. Iniciando sesi√≥n...`, 'info');
                            await signInWithEmailAndPassword(auth, email, password);
                        } else {
                            throw e;
                        }
                    }

                    const uid = auth.currentUser.uid;
                    const userRef = doc(db, 'users', uid);
                    const existing = await getDoc(userRef);
                    if (existing.exists()) {
                        await updateDoc(userRef, {
                            alias,
                            gender,
                            birthDate,
                            hasActiveSubscription: true,
                            hasAntiGhostingInsurance: true
                        });
                        log(`üõ†Ô∏è Perfil actualizado: ${email}`, 'info');
                    } else {
                        await setDoc(userRef, {
                            uid,
                            email,
                            alias,
                            gender,
                            birthDate,
                            userRole: 'regular',
                            hasActiveSubscription: true,
                            hasAntiGhostingInsurance: true,
                            createdAt: serverTimestamp()
                        });
                        log(`üßæ Perfil creado en Firestore: ${email}`, 'success');
                    }
                }

                await ensureUser({
                    email: 'gonzalo.hrrj@gmail.com',
                    password: 'Temporal123!',
                    alias: 'Gonzalo',
                    gender: 'masculino',
                    birthDate: '1990-01-01'
                });
                await signOut(auth);

                await ensureUser({
                    email: 'lacasitadebarajas@gmail.com',
                    password: 'Temporal123!',
                    alias: 'La Casita',
                    gender: 'femenino',
                    birthDate: '1992-05-10'
                });

                log('üéâ Cuentas listas. Inicia sesi√≥n en el frontend para navegar.', 'success');
            } catch (error) {
                log(`‚ùå Error creando cuentas: ${error.message}`, 'error');
                console.error(error);
            }
        };

        // Log environment info
        log(`üåê Entorno: ${location.hostname} (${location.protocol})`, 'info');
        log(`üì± Navegador: ${navigator.userAgent.substring(0, 50)}...`, 'info');
        log(`üîå Estado de red: ${navigator.onLine ? 'Online' : 'Offline'}`, navigator.onLine ? 'success' : 'error');
        try {
            const already = localStorage.getItem('testUsersCreated');
            if (!already) {
                await createTestUsers();
                localStorage.setItem('testUsersCreated', 'true');
            }
        } catch {}

    </script>
</body>
</html>