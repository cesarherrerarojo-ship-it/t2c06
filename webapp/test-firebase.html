<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test - TuCitaSegura</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>üîß Firebase Connection Test</h1>
    <p>Prueba de conectividad con Firebase para TuCitaSegura</p>

    <div class="test-section">
        <h3>üìä Estado de Conexi√≥n</h3>
        <div id="connection-status">
            <div class="info">‚è≥ Iniciando pruebas...</div>
        </div>
    </div>

    <div class="test-section">
        <h3>üß™ Pruebas Disponibles</h3>
        <button onclick="testFirebaseConnection()">Probar Conexi√≥n Firebase</button>
        <button onclick="testAuthConnection()">Probar Autenticaci√≥n</button>
        <button onclick="testAppCheck()">Probar App Check</button>
        <button onclick="clearLogs()">Limpiar Logs</button>
    </div>

    <div class="test-section">
        <h3>üìã Logs de Pruebas</h3>
        <div id="test-logs"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, connectAuthEmulator } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgFcoHwoBpo80rlEHL2hHVZ2DqtjWXh2s",
            authDomain: "tuscitasseguras-2d1a6.firebaseapp.com",
            projectId: "tuscitasseguras-2d1a6",
            storageBucket: "tuscitasseguras-2d1a6.firebasestorage.app",
            messagingSenderId: "924208562587",
            appId: "1:924208562587:web:5291359426fe390b36213e"
        };

        let app, auth, db;
        let testsPassed = 0;
        let testsFailed = 0;

        function log(message, type = 'info') {
            const logsContainer = document.getElementById('test-logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="${type}">[${new Date().toLocaleTimeString()}] ${message}</span>`;
            logsContainer.appendChild(entry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            document.getElementById('connection-status').innerHTML = `<div class="${type}">${message}</div>`;
        }

        window.clearLogs = function() {
            document.getElementById('test-logs').innerHTML = '';
            testsPassed = 0;
            testsFailed = 0;
        };

        window.testFirebaseConnection = async function() {
            try {
                log('üöÄ Iniciando conexi√≥n con Firebase...', 'info');
                
                app = initializeApp(firebaseConfig);
                log('‚úÖ Firebase app inicializada correctamente', 'success');
                
                auth = getAuth(app);
                log('‚úÖ Firebase Auth inicializado', 'success');
                
                db = getFirestore(app);
                log('‚úÖ Firestore inicializado', 'success');
                
                updateStatus('‚úÖ Conexi√≥n Firebase exitosa', 'success');
                testsPassed++;
                
            } catch (error) {
                log(`‚ùå Error en conexi√≥n Firebase: ${error.message}`, 'error');
                updateStatus('‚ùå Error en conexi√≥n Firebase', 'error');
                testsFailed++;
                console.error('Firebase connection error:', error);
            }
        };

        window.testAuthConnection = async function() {
            if (!auth) {
                log('‚ö†Ô∏è Primero debes probar la conexi√≥n Firebase', 'warning');
                return;
            }

            try {
                log('üîê Probando conexi√≥n con Auth...', 'info');
                
                // Test auth connection by checking current user
                const user = auth.currentUser;
                if (user) {
                    log(`‚úÖ Usuario actual: ${user.email}`, 'success');
                } else {
                    log('‚ÑπÔ∏è No hay usuario autenticado actualmente', 'info');
                }
                
                // Test auth state listener
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        log(`‚úÖ Auth state: Usuario autenticado (${user.email})`, 'success');
                    } else {
                        log('‚ÑπÔ∏è Auth state: Sin autenticaci√≥n', 'info');
                    }
                });
                
                log('‚úÖ Conexi√≥n Auth exitosa', 'success');
                testsPassed++;
                
            } catch (error) {
                log(`‚ùå Error en conexi√≥n Auth: ${error.message}`, 'error');
                testsFailed++;
                console.error('Auth connection error:', error);
            }
        };

        window.testAppCheck = async function() {
            try {
                log('üîç Probando App Check...', 'info');
                
                // Import App Check
                const { initializeAppCheck, ReCaptchaEnterpriseProvider } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js");
                
                // Check if we're in development mode
                const isDevelopment = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                
                if (isDevelopment) {
                    log('‚ö†Ô∏è Modo desarrollo detectado - App Check desactivado', 'warning');
                    updateStatus('‚ö†Ô∏è App Check desactivado en desarrollo', 'warning');
                    return;
                }
                
                // Initialize App Check
                const appCheck = initializeAppCheck(app, {
                    provider: new ReCaptchaEnterpriseProvider('6LfdTvQrAAAAACkGjvbbFIkqHMsTHwRYYZS_CGq2'),
                    isTokenAutoRefreshEnabled: true
                });
                
                log('‚úÖ App Check inicializado', 'success');
                
                // Test token generation
                const { getToken } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js");
                const tokenResult = await getToken(appCheck, false);
                
                if (tokenResult && tokenResult.token) {
                    log('‚úÖ Token App Check generado exitosamente', 'success');
                    log(`üìã Token preview: ${tokenResult.token.substring(0, 50)}...`, 'info');
                    testsPassed++;
                } else {
                    log('‚ùå No se pudo generar token App Check', 'error');
                    testsFailed++;
                }
                
            } catch (error) {
                log(`‚ùå Error en App Check: ${error.message}`, 'error');
                
                if (error.message.includes('400')) {
                    log('üìù C√≥digo 400: Posible problema con dominio o site key', 'warning');
                    log('üîß Soluci√≥n: Verifica que localhost est√© en la lista de dominios permitidos', 'info');
                }
                
                testsFailed++;
                console.error('App Check error:', error);
            }
        };

        // Auto-run basic test on page load
        setTimeout(() => {
            log('üöÄ Iniciando pruebas autom√°ticas...', 'info');
            window.testFirebaseConnection();
        }, 1000);

        // Log environment info
        log(`üåê Hostname: ${location.hostname}`, 'info');
        log(`üîó Protocol: ${location.protocol}`, 'info');
        log(`üì± User Agent: ${navigator.userAgent.substring(0, 50)}...`, 'info');

    </script>
</body>
</html>