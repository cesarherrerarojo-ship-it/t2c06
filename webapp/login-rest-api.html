<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iniciar Sesi√≥n - REST API (Bypass Total) - TuCitaSegura</title>

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="./css/output.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .glass-strong {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    input:focus {
      outline: none;
      border-color: rgba(99, 102, 241, 0.5);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Debug styles */
    .debug-panel {
      background: rgba(0, 0, 0, 0.8);
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .debug-error {
      color: #ff4444;
    }
    
    .debug-success {
      color: #44ff44;
    }
    
    .debug-warning {
      color: #ffff44;
    }

    .rest-api-badge {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
    }
  </style>
</head>
<body class="text-white">

  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 z-50 glass">
    <div class="container mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <i class="fas fa-shield-alt text-2xl text-purple-300"></i>
          <h1 class="text-xl font-bold">TuCitaSegura</h1>
        </div>
        <div class="flex items-center space-x-4">
          <span class="rest-api-badge">REST API</span>
          <span class="text-sm bg-red-500 px-2 py-1 rounded">BYPASS MODE</span>
          <button onclick="toggleDebugPanel()" class="text-sm bg-blue-500 px-3 py-1 rounded hover:bg-blue-600">
            <i class="fas fa-bug mr-1"></i>Debug Panel
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8 min-h-screen flex items-center justify-center">
    <div class="w-full max-w-md">
      
      <!-- Debug Panel (Hidden by default) -->
      <div id="debugPanel" class="mb-4 debug-panel rounded-lg p-4 hidden">
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-lg font-bold">REST API Debug Console</h3>
          <button onclick="clearDebugLog()" class="text-xs bg-red-600 px-2 py-1 rounded">Clear</button>
        </div>
        <div id="debugLog" class="space-y-1"></div>
      </div>

      <!-- Warning Banner -->
      <div class="mb-4 bg-yellow-600 border border-yellow-500 rounded-lg p-4">
        <div class="flex items-center">
          <i class="fas fa-exclamation-triangle text-yellow-200 mr-2"></i>
          <div>
            <h3 class="font-bold text-yellow-100">Modo Bypass REST API</h3>
            <p class="text-sm text-yellow-100">Usando API directa de Firebase - Sin Cloud Functions</p>
          </div>
        </div>
      </div>

      <!-- Login Form -->
      <div class="glass-strong rounded-2xl p-8 fade-in">
        <div class="text-center mb-8">
          <div class="w-16 h-16 bg-gradient-to-r from-purple-400 to-pink-400 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-user text-2xl text-white"></i>
          </div>
          <h2 class="text-2xl font-bold mb-2">Iniciar Sesi√≥n</h2>
          <p class="text-gray-300">REST API Bypass - Direct Firebase Auth</p>
        </div>

        <!-- Quick Test Buttons -->
        <div class="mb-6 space-y-2">
          <button onclick="testRestAPIConnection()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
            <i class="fas fa-plug mr-2"></i>Test REST API Connection
          </button>
          <button onclick="testDirectAPI()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
            <i class="fas fa-bolt mr-2"></i>Test Direct API Call
          </button>
        </div>

        <form id="loginForm" class="space-y-6">
          <div>
            <label class="block text-sm font-medium mb-2" for="email">Correo Electr√≥nico</label>
            <div class="relative">
              <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                <i class="fas fa-envelope"></i>
              </span>
              <input type="email" id="email" name="email" required
                     class="w-full pl-10 pr-4 py-3 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-white placeholder-gray-300"
                     placeholder="tu@email.com"
                     value="cesar.herrera.rojo@gmail.com">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-2" for="password">Contrase√±a</label>
            <div class="relative">
              <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                <i class="fas fa-lock"></i>
              </span>
              <input type="password" id="password" name="password" required
                     class="w-full pl-10 pr-10 py-3 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-white placeholder-gray-300"
                     placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              <button type="button" onclick="togglePassword()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                <i class="fas fa-eye" id="toggleIcon"></i>
              </button>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <label class="flex items-center">
              <input type="checkbox" id="rememberMe" name="rememberMe" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
              <span class="ml-2 text-sm text-gray-300">Recu√©rdame</span>
            </label>
            <a href="#" onclick="showForgotPassword()" class="text-sm text-purple-300 hover:text-purple-200">¬øOlvidaste tu contrase√±a?</a>
          </div>

          <button type="submit" id="loginButton" 
                  class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105">
            <span id="loginButtonText">
              <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n
            </span>
            <span id="loginButtonLoading" class="hidden">
              <i class="fas fa-spinner fa-spin mr-2"></i>Iniciando sesi√≥n...
            </span>
          </button>
        </form>

        <div class="mt-6 text-center">
          <p class="text-gray-300">¬øNo tienes una cuenta? 
            <a href="register.html" class="text-purple-300 hover:text-purple-200 font-medium">Reg√≠strate aqu√≠</a>
          </p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="mt-6 hidden">
          <div class="border-t border-white border-opacity-20 pt-4">
            <h4 class="text-sm font-medium mb-2">Resultados de la Prueba:</h4>
            <div id="testResults" class="text-xs space-y-1"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toast" class="fixed top-20 right-4 transform translate-x-full transition-transform duration-300 z-50">
    <div class="bg-white text-gray-900 px-6 py-3 rounded-lg shadow-lg flex items-center">
      <i id="toastIcon" class="fas fa-check-circle text-green-500 mr-2"></i>
      <span id="toastMessage"></span>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    // Import REST API authentication
    import { 
      restSignInWithEmailAndPassword, 
      testRestAPIConnectivity,
      getCurrentUser,
      signOut
    } from './js/firebase-rest-auth.js';
    
    // Make functions available globally
    window.restSignInWithEmailAndPassword = restSignInWithEmailAndPassword;
    window.testRestAPIConnectivity = testRestAPIConnectivity;
    window.getCurrentUser = getCurrentUser;
    window.signOut = signOut;

    // Debug logging function
    function debugLog(message, type = 'info') {
      const debugLogDiv = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      const colorClass = type === 'error' ? 'debug-error' : type === 'success' ? 'debug-success' : type === 'warning' ? 'debug-warning' : '';
      
      const logEntry = document.createElement('div');
      logEntry.className = colorClass;
      logEntry.textContent = `[${timestamp}] ${message}`;
      
      debugLogDiv.appendChild(logEntry);
      debugLogDiv.scrollTop = debugLogDiv.scrollHeight;
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // Make debugLog available globally
    window.debugLog = debugLog;

    // Initialize debug
    debugLog('üöÄ REST API login page loaded', 'info');
    debugLog(`üìç Current hostname: ${location.hostname}`, 'info');
    debugLog('üîß Using Firebase REST API - Complete Cloud Function bypass', 'info');

    // Login form submission
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const rememberMe = document.getElementById('rememberMe').checked;
      const loginButton = document.getElementById('loginButton');
      const loginButtonText = document.getElementById('loginButtonText');
      const loginButtonLoading = document.getElementById('loginButtonLoading');

      debugLog(`üîê REST API: Attempting login for: ${email}`, 'info');
      debugLog(`üíæ Remember me: ${rememberMe}`, 'info');

      // Disable button and show loading
      loginButton.disabled = true;
      loginButtonText.classList.add('hidden');
      loginButtonLoading.classList.remove('hidden');

      try {
        // Use REST API authentication - COMPLETE BYPASS
        debugLog('üîÑ REST API: Calling signInWithPassword endpoint...', 'info');
        
        const userCredential = await restSignInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        debugLog(`‚úÖ REST API: Authentication successful!`, 'success');
        debugLog(`üìß User ID: ${user.uid}`, 'info');
        debugLog(`üìß Email: ${user.email}`, 'info');
        debugLog(`‚úÖ Email verified: ${user.emailVerified}`, 'info');

        // Store user data in localStorage for persistence
        if (rememberMe) {
          localStorage.setItem('restApiUser', JSON.stringify(user));
          localStorage.setItem('restApiToken', user.token);
        } else {
          sessionStorage.setItem('restApiUser', JSON.stringify(user));
          sessionStorage.setItem('restApiToken', user.token);
        }

        // Show success
        showToast('¬°Bienvenido de vuelta! (REST API)', 'success');

        // Show results section
        showResults(user);

        // Redirect to app after delay
        debugLog('üîÑ Redirecting to app...', 'info');
        setTimeout(() => {
          window.location.href = '/webapp/buscar-usuarios.html?auth=rest';
        }, 2000);

      } catch (error) {
        debugLog(`‚ùå REST API: Authentication failed: ${error.code} - ${error.message}`, 'error');
        console.error('REST API Login error:', error);

        // Detailed error analysis
        if (error.code === 'auth/user-not-found') {
          showToast('Usuario no encontrado', 'error');
          debugLog('‚ùå User not found in Firebase', 'error');
        } else if (error.code === 'auth/wrong-password') {
          showToast('Contrase√±a incorrecta', 'error');
          debugLog('‚ùå Invalid password', 'error');
        } else if (error.code === 'auth/invalid-email') {
          showToast('Email inv√°lido', 'error');
          debugLog('‚ùå Invalid email format', 'error');
        } else if (error.code === 'auth/user-disabled') {
          showToast('Usuario deshabilitado', 'error');
          debugLog('‚ùå User account is disabled', 'error');
        } else if (error.code === 'auth/too-many-requests') {
          showToast('Demasiados intentos fallidos', 'error');
          debugLog('‚ùå Too many failed attempts', 'error');
        } else {
          showToast(`Error: ${error.message}`, 'error');
          debugLog(`‚ùå Unexpected error: ${error.message}`, 'error');
        }

      } finally {
        // Re-enable button
        loginButton.disabled = false;
        loginButtonText.classList.remove('hidden');
        loginButtonLoading.classList.add('hidden');
      }
    });

    // Test functions
    window.testRestAPIConnection = async function() {
      debugLog('üß™ Testing REST API connectivity...', 'info');
      try {
        const result = await testRestAPIConnectivity();
        if (result) {
          debugLog('‚úÖ REST API connection test successful', 'success');
          showToast('‚úÖ REST API conectado', 'success');
        } else {
          debugLog('‚ö†Ô∏è REST API connection test failed', 'warning');
          showToast('‚ö†Ô∏è REST API no disponible', 'warning');
        }
      } catch (error) {
        debugLog(`‚ùå REST API connection test error: ${error.message}`, 'error');
        showToast('‚ùå Error conectando REST API', 'error');
      }
    };

    window.testDirectAPI = async function() {
      debugLog('üß™ Testing direct API call...', 'info');
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      try {
        // Test direct API call
        const response = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=AIzaSyAgFcoHwoBpo80rlEHL2hHVZ2DqtjWXh2s`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            password: password,
            returnSecureToken: true
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          debugLog('‚úÖ Direct API call successful!', 'success');
          debugLog(`üìß Local ID: ${data.localId}`, 'info');
          debugLog(`üìß Email: ${data.email}`, 'info');
          showToast('‚úÖ API Directa exitosa', 'success');
          
          // Show results
          showResults(data);
        } else {
          const errorData = await response.json();
          debugLog(`‚ùå Direct API call failed: ${errorData.error.message}`, 'error');
          debugLog(`üìÑ Error code: ${errorData.error.code}`, 'error');
          showToast('‚ùå API Directa fall√≥', 'error');
        }
      } catch (error) {
        debugLog(`‚ùå Direct API test failed: ${error.message}`, 'error');
        showToast('‚ùå Error en API directa', 'error');
      }
    };

    window.showResults = function(userData) {
      const resultsSection = document.getElementById('resultsSection');
      const testResults = document.getElementById('testResults');
      
      resultsSection.classList.remove('hidden');
      
      testResults.innerHTML = `
        <div class="bg-green-900 bg-opacity-50 p-3 rounded border border-green-500">
          <div class="text-green-300 font-bold mb-2">‚úÖ Autenticaci√≥n Exitosa</div>
          <div class="text-xs space-y-1">
            <div><strong>User ID:</strong> ${userData.localId || userData.uid}</div>
            <div><strong>Email:</strong> ${userData.email}</div>
            <div><strong>Email Verified:</strong> ${userData.emailVerified || 'N/A'}</div>
            <div><strong>Token Expires:</strong> ${userData.expiresIn || 'N/A'}s</div>
          </div>
        </div>
      `;
    };

    window.togglePassword = function() {
      const passwordInput = document.getElementById('password');
      const toggleIcon = document.getElementById('toggleIcon');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash';
      } else {
        passwordInput.type = 'password';
        toggleIcon.className = 'fas fa-eye';
      }
    };

    window.toggleDebugPanel = function() {
      const panel = document.getElementById('debugPanel');
      panel.classList.toggle('hidden');
    };

    window.clearDebugLog = function() {
      document.getElementById('debugLog').innerHTML = '';
      debugLog('üóëÔ∏è Debug log cleared', 'info');
    };

    window.showToast = function(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      
      // Set icon based on type
      if (type === 'success') {
        toastIcon.className = 'fas fa-check-circle text-green-500 mr-2';
      } else if (type === 'error') {
        toastIcon.className = 'fas fa-exclamation-circle text-red-500 mr-2';
      } else if (type === 'warning') {
        toastIcon.className = 'fas fa-exclamation-triangle text-yellow-500 mr-2';
      }
      
      toastMessage.textContent = message;
      toast.classList.remove('translate-x-full');
      
      setTimeout(() => {
        toast.classList.add('translate-x-full');
      }, 3000);
    };

    window.showForgotPassword = function() {
      debugLog('üîÑ Redirecting to password reset...', 'info');
      window.location.href = '#forgot-password';
    };

    // Check for existing session on load
    window.addEventListener('load', () => {
      const storedUser = localStorage.getItem('restApiUser') || sessionStorage.getItem('restApiUser');
      if (storedUser) {
        debugLog('üë§ Existing REST API session found', 'info');
        const user = JSON.parse(storedUser);
        showResults(user);
        
        // Auto-redirect after 3 seconds
        setTimeout(() => {
          window.location.href = '/webapp/buscar-usuarios.html?auth=rest';
        }, 3000);
      }
    });

  </script>
</body>
</html>