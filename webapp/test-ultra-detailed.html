<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Ultra-Resiliente - Resultados Detallados</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .method-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .method-card {
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }
        .method-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .method-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .method-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }
        .status-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-testing { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-pending { background: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
        .method-details {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            line-height: 1.4;
        }
        .error-details {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 11px;
            color: #c53030;
        }
        .success-details {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 11px;
            color: #22543d;
        }
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .summary {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        .stat {
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }
        .log-container {
            background: #0f0f0f;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Test Ultra-Resiliente de Autenticaci√≥n Firebase</h1>
        
        <div class="controls">
            <button class="btn" onclick="startUltraTest()">üß™ Iniciar Test Completo</button>
            <button class="btn" onclick="testConnectivityOnly()">üîó Solo Conectividad</button>
            <button class="btn" onclick="testAuthenticationOnly()">üîê Solo Autenticaci√≥n</button>
            <button class="btn" onclick="clearResults()">üóëÔ∏è Limpiar Resultados</button>
        </div>

        <div class="summary" id="summary" style="display: none;">
            <h3>üìä Resumen de Resultados</h3>
            <div class="summary-stats">
                <div class="stat">
                    <span class="stat-number" id="totalMethods">0</span>
                    <span>M√©todos Totales</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="successfulMethods">0</span>
                    <span>M√©todos Exitosos</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="failedMethods">0</span>
                    <span>M√©todos Fallidos</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="successRate">0%</span>
                    <span>Tasa de √âxito</span>
                </div>
            </div>
        </div>

        <div class="method-grid" id="methodGrid">
            <!-- Los m√©todos se generar√°n din√°micamente -->
        </div>

        <div class="log-container" id="logContainer">
            <div class="log-entry">üöÄ Sistema de test iniciado. Haz clic en un bot√≥n para comenzar.</div>
        </div>
    </div>

    <script>
        // Firebase Configuration (directly defined to avoid import issues)
        const FIREBASE_API_KEY = "AIzaSyAgFcoHwoBpo80rlEHL2hHVZ2DqtjWXh2s";
        const FIREBASE_PROJECT_ID = "tu-cita-segura";
        const FIREBASE_AUTH_DOMAIN = "tu-cita-segura.firebaseapp.com";
        
        class UltraAuthTester {
            constructor() {
                this.apiKey = FIREBASE_API_KEY;
                this.projectId = FIREBASE_PROJECT_ID;
                this.authDomain = FIREBASE_AUTH_DOMAIN;
                this.results = [];
                this.methods = [
                    {
                        id: 'direct',
                        name: 'Conexi√≥n Directa',
                        description: 'Conexi√≥n directa a Firebase Auth API',
                        test: this.testDirectConnection.bind(this)
                    },
                    {
                        id: 'proxy1',
                        name: 'Proxy CORS #1',
                        description: 'Usando cors-anywhere.herokuapp.com',
                        test: () => this.testProxyConnection('https://cors-anywhere.herokuapp.com')
                    },
                    {
                        id: 'proxy2',
                        name: 'Proxy CORS #2',
                        description: 'Usando api.allorigins.win',
                        test: () => this.testProxyConnection('https://api.allorigins.win/raw')
                    },
                    {
                        id: 'proxy3',
                        name: 'Proxy CORS #3',
                        description: 'Usando corsproxy.io',
                        test: () => this.testProxyConnection('https://corsproxy.io/?')
                    },
                    {
                        id: 'jsonp',
                        name: 'JSONP Bypass',
                        description: 'T√©cnica JSONP para bypass',
                        test: this.testJSONPMethod.bind(this)
                    },
                    {
                        id: 'form',
                        name: 'Form Submission',
                        description: 'Env√≠o mediante formulario',
                        test: this.testFormSubmission.bind(this)
                    },
                    {
                        id: 'beacon',
                        name: 'Image Beacon',
                        description: 'T√©cnica de imagen beacon',
                        test: this.testImageBeacon.bind(this)
                    },
                    {
                        id: 'websocket',
                        name: 'WebSocket Tunnel',
                        description: 'T√∫nel WebSocket',
                        test: this.testWebSocket.bind(this)
                    },
                    {
                        id: 'xhr',
                        name: 'XHR Extremo',
                        description: 'XMLHttpRequest con configuraci√≥n extrema',
                        test: this.testXHR.bind(this)
                    },
                    {
                        id: 'fetch',
                        name: 'Fetch Avanzado',
                        description: 'Fetch API con m√∫ltiples configuraciones',
                        test: this.testAdvancedFetch.bind(this)
                    }
                ];
            }

            log(message, type = 'info') {
                const logContainer = document.getElementById('logContainer');
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.style.color = type === 'error' ? '#ff6b6b' : 
                                     type === 'success' ? '#51cf66' : 
                                     type === 'warning' ? '#ffd93d' : '#00ff00';
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                console.log(`[${type.toUpperCase()}] ${message}`);
            }

            async testDirectConnection() {
                this.log('üß™ Probando conexi√≥n directa...', 'info');
                
                const configs = [
                    {
                        mode: 'cors',
                        headers: { 'Content-Type': 'application/json' }
                    },
                    {
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' }
                    }
                ];

                for (const config of configs) {
                    try {
                        const response = await fetch(
                            `https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${this.apiKey}`,
                            {
                                method: 'POST',
                                ...config,
                                body: JSON.stringify({ idToken: 'test-token' })
                            }
                        );

                        this.log(`üì° Config ${config.mode}: Status ${response.status}`, 'info');
                        
                        if (response.status === 200 || response.type === 'opaque') {
                            return { success: true, method: 'direct', config: config.mode };
                        }
                    } catch (error) {
                        this.log(`‚ö†Ô∏è Config ${config.mode} fall√≥: ${error.message}`, 'warning');
                    }
                }
                
                return { success: false, error: 'Todas las configuraciones directas fallaron' };
            }

            async testProxyConnection(proxyBase) {
                this.log(`üß™ Probando proxy: ${proxyBase}`, 'info');
                
                try {
                    const proxyUrl = `${proxyBase}https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${this.apiKey}`;
                    
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ idToken: 'test-token' })
                    });

                    this.log(`üì° Proxy response: Status ${response.status}`, 'info');
                    
                    if (response.ok) {
                        return { success: true, method: 'proxy', proxy: proxyBase };
                    }
                    
                    return { success: false, error: `Status ${response.status}` };
                } catch (error) {
                    this.log(`‚ùå Proxy error: ${error.message}`, 'error');
                    return { success: false, error: error.message };
                }
            }

            async testJSONPMethod() {
                this.log('üß™ Probando m√©todo JSONP...', 'info');
                
                return new Promise((resolve) => {
                    const callbackName = `jsonp_callback_${Date.now()}`;
                    const script = document.createElement('script');
                    
                    window[callbackName] = function(data) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        resolve({ success: true, method: 'jsonp', data: data });
                    };
                    
                    script.onerror = () => {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        resolve({ success: false, error: 'JSONP failed' });
                    };
                    
                    script.src = `https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${this.apiKey}&callback=${callbackName}`;
                    document.body.appendChild(script);
                    
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            document.body.removeChild(script);
                            resolve({ success: false, error: 'JSONP timeout' });
                        }
                    }, 10000);
                });
            }

            async testFormSubmission() {
                this.log('üß™ Probando env√≠o por formulario...', 'info');
                
                try {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${this.apiKey}`;
                    form.target = 'hidden_iframe';
                    form.style.display = 'none';
                    
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'idToken';
                    input.value = 'test-token';
                    form.appendChild(input);
                    
                    const iframe = document.createElement('iframe');
                    iframe.name = 'hidden_iframe';
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                    
                    return new Promise((resolve) => {
                        let timeout = setTimeout(() => {
                            document.body.removeChild(form);
                            document.body.removeChild(iframe);
                            resolve({ success: false, error: 'Form submission timeout' });
                        }, 8000);
                        
                        iframe.onload = () => {
                            clearTimeout(timeout);
                            document.body.removeChild(form);
                            document.body.removeChild(iframe);
                            resolve({ success: true, method: 'form' });
                        };
                        
                        iframe.onerror = () => {
                            clearTimeout(timeout);
                            document.body.removeChild(form);
                            document.body.removeChild(iframe);
                            resolve({ success: false, error: 'Form submission failed' });
                        };
                        
                        document.body.appendChild(form);
                        form.submit();
                    });
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            async testImageBeacon() {
                this.log('üß™ Probando t√©cnica Image Beacon...', 'info');
                
                return new Promise((resolve) => {
                    const img = new Image();
                    const timeout = setTimeout(() => {
                        resolve({ success: false, error: 'Image beacon timeout' });
                    }, 8000);
                    
                    img.onload = () => {
                        clearTimeout(timeout);
                        resolve({ success: true, method: 'beacon' });
                    };
                    
                    img.onerror = () => {
                        clearTimeout(timeout);
                        // Even if it errors, it might have connected
                        resolve({ success: true, method: 'beacon', note: 'Connected but returned error' });
                    };
                    
                    img.src = `https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${this.apiKey}&test=${Date.now()}`;
                });
            }

            async testWebSocket() {
                this.log('üß™ Probando WebSocket tunnel...', 'info');
                
                // This is a conceptual test - WebSocket to Firebase Auth isn't standard
                return { success: false, error: 'WebSocket method not implemented for Firebase Auth' };
            }

            async testXHR() {
                this.log('üß™ Probando XHR extremo...', 'info');
                
                return new Promise((resolve) => {
                    const xhr = new XMLHttpRequest();
                    let completed = false;
                    
                    const timeout = setTimeout(() => {
                        if (!completed) {
                            completed = true;
                            xhr.abort();
                            resolve({ success: false, error: 'XHR timeout' });
                        }
                    }, 10000);
                    
                    xhr.onreadystatechange = function() {
                        if (completed) return;
                        
                        if (xhr.readyState === 4) {
                            completed = true;
                            clearTimeout(timeout);
                            
                            if (xhr.status === 200 || xhr.status === 0) {
                                resolve({ success: true, method: 'xhr', status: xhr.status });
                            } else {
                                resolve({ success: false, error: `XHR status ${xhr.status}` });
                            }
                        }
                    };
                    
                    xhr.onerror = function() {
                        if (completed) return;
                        completed = true;
                        clearTimeout(timeout);
                        // Status 0 might indicate a successful connection with CORS issues
                        resolve({ success: xhr.status === 0, method: 'xhr', status: xhr.status });
                    };
                    
                    xhr.open('POST', `https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${this.apiKey}`, true);
                    xhr.setRequestHeader('Content-Type', 'text/plain');
                    xhr.send(JSON.stringify({ idToken: 'test-token' }));
                });
            }

            async testAdvancedFetch() {
                this.log('üß™ Probando Fetch avanzado...', 'info');
                
                const configs = [
                    {
                        method: 'POST',
                        mode: 'cors',
                        credentials: 'omit',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        },
                        body: JSON.stringify({ idToken: 'test-token' })
                    },
                    {
                        method: 'POST',
                        mode: 'no-cors',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'text/plain'
                        },
                        body: JSON.stringify({ idToken: 'test-token' })
                    },
                    {
                        method: 'POST',
                        mode: 'same-origin',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({ idToken: 'test-token' }).toString()
                    }
                ];

                for (const config of configs) {
                    try {
                        const response = await fetch(
                            `https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${this.apiKey}`,
                            config
                        );
                        
                        this.log(`üì° Fetch config: Status ${response.status}, Type ${response.type}`, 'info');
                        
                        if (response.ok || response.type === 'opaque') {
                            return { success: true, method: 'fetch', config: config.mode };
                        }
                    } catch (error) {
                        this.log(`‚ö†Ô∏è Fetch config fall√≥: ${error.message}`, 'warning');
                    }
                }
                
                return { success: false, error: 'Todas las configuraciones de fetch fallaron' };
            }

            async runConnectivityTests() {
                this.log('üöÄ Iniciando tests de conectividad...', 'info');
                this.results = [];
                
                const methodGrid = document.getElementById('methodGrid');
                methodGrid.innerHTML = '';
                
                for (const method of this.methods) {
                    const card = this.createMethodCard(method);
                    methodGrid.appendChild(card);
                    
                    // Test the method
                    this.updateMethodStatus(method.id, 'testing', 'Probando...');
                    
                    try {
                        const result = await method.test();
                        this.results.push({ method: method.id, ...result });
                        
                        if (result.success) {
                            this.updateMethodStatus(method.id, 'success', '‚úÖ Conectado', result);
                        } else {
                            this.updateMethodStatus(method.id, 'error', `‚ùå ${result.error}`, result);
                        }
                    } catch (error) {
                        this.results.push({ method: method.id, success: false, error: error.message });
                        this.updateMethodStatus(method.id, 'error', `‚ùå ${error.message}`);
                    }
                }
                
                this.updateSummary();
                this.log('‚úÖ Tests de conectividad completados', 'success');
            }

            createMethodCard(method) {
                const card = document.createElement('div');
                card.className = 'method-card';
                card.id = `method-${method.id}`;
                card.innerHTML = `
                    <div class="method-header">
                        <div class="method-name">${method.name}</div>
                        <div class="status-indicator status-pending" id="status-${method.id}">Pendiente</div>
                    </div>
                    <div class="method-details">${method.description}</div>
                    <div id="details-${method.id}"></div>
                `;
                return card;
            }

            updateMethodStatus(methodId, status, message, details = null) {
                const statusElement = document.getElementById(`status-${methodId}`);
                const detailsElement = document.getElementById(`details-${methodId}`);
                
                statusElement.className = `status-indicator status-${status}`;
                statusElement.textContent = message;
                
                if (details) {
                    if (details.success) {
                        detailsElement.innerHTML = `
                            <div class="success-details">
                                ‚úÖ M√©todo exitoso<br>
                                ${details.method ? `M√©todo: ${details.method}<br>` : ''}
                                ${details.config ? `Config: ${details.config}<br>` : ''}
                                ${details.proxy ? `Proxy: ${details.proxy}<br>` : ''}
                            </div>
                        `;
                    } else {
                        detailsElement.innerHTML = `
                            <div class="error-details">
                                ‚ùå Error: ${details.error}<br>
                                ${details.status ? `Status: ${details.status}<br>` : ''}
                            </div>
                        `;
                    }
                }
            }

            updateSummary() {
                const successful = this.results.filter(r => r.success).length;
                const failed = this.results.filter(r => !r.success).length;
                const total = this.results.length;
                const rate = total > 0 ? Math.round((successful / total) * 100) : 0;
                
                document.getElementById('totalMethods').textContent = total;
                document.getElementById('successfulMethods').textContent = successful;
                document.getElementById('failedMethods').textContent = failed;
                document.getElementById('successRate').textContent = `${rate}%`;
                
                document.getElementById('summary').style.display = 'block';
                
                this.log(`üìä Resumen: ${successful}/${total} m√©todos exitosos (${rate}%)`, 
                        successful > 0 ? 'success' : 'warning');
            }

            getWorkingMethods() {
                return this.results.filter(r => r.success);
            }
        }

        // Global functions
        window.ultraTester = new UltraAuthTester();
        
        window.startUltraTest = async function() {
            await window.ultraTester.runConnectivityTests();
        };
        
        window.testConnectivityOnly = async function() {
            await window.ultraTester.runConnectivityTests();
        };
        
        window.testAuthenticationOnly = async function() {
            // This would test actual authentication with credentials
            window.ultraTester.log('üîê Para probar autenticaci√≥n, usa login-ultra.html con credenciales reales', 'warning');
        };
        
        window.clearResults = function() {
            document.getElementById('methodGrid').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            document.getElementById('logContainer').innerHTML = '<div class="log-entry">üöÄ Sistema de test reiniciado.</div>';
        };
    </script>
</body>
</html>